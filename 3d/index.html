<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Hệ thống hạt 3D Tương tác</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; font-family: sans-serif; }
        #ui { position: absolute; top: 20px; left: 20px; z-index: 10; color: white; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; }
        canvas { display: block; }
        video { transform: scaleX(-1); position: absolute; bottom: 10px; right: 10px; width: 200px; border: 2px solid #555; border-radius: 8px; }
    </style>
</head>
<body>

    <div id="ui">
        <h2>Điều khiển Hạt</h2>
        <label>Màu sắc: </label>
        <input type="color" id="colorPicker" value="#00ffcc"><br><br>
        <div id="status">Đang khởi tạo Camera...</div>
    </div>

    <video id="webcam" autoplay playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        // --- CẤU HÌNH THREE.JS ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const particleCount = 10000;
        const positions = new Float32Array(particleCount * 3);
        const velocities = new Float32Array(particleCount * 3);
        const originalPositions = new Float32Array(particleCount * 3);

        // Khởi tạo hạt thành hình cầu
        for (let i = 0; i < particleCount; i++) {
            const phi = Math.acos(-1 + (2 * i) / particleCount);
            const theta = Math.sqrt(particleCount * Math.PI) * phi;
            
            const x = 2 * Math.cos(theta) * Math.sin(phi);
            const y = 2 * Math.sin(theta) * Math.sin(phi);
            const z = 2 * Math.cos(phi);

            originalPositions[i * 3] = x;
            originalPositions[i * 3 + 1] = y;
            originalPositions[i * 3 + 2] = z;

            positions[i * 3] = x;
            positions[i * 3 + 1] = y;
            positions[i * 3 + 2] = z;
        }

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const material = new THREE.PointsMaterial({ size: 0.03, color: 0x00ffcc, transparent: true });
        const particles = new THREE.Points(geometry, material);
        scene.add(particles);

        camera.position.z = 5;

        // --- NHẬN DIỆN TAY (MEDIAPIPE) ---
        let expansionFactor = 1; // 1 là hình cầu, >1 là mở rộng
        const videoElement = document.getElementById('webcam');
        const statusDisplay = document.getElementById('status');

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length >= 2) {
                statusDisplay.innerText = "Trạng thái: Đã nhận diện 2 tay";
                
                // Tính khoảng cách giữa 2 bàn tay để làm thông số "Căng"
                const hand1 = results.multiHandLandmarks[0][9]; // Gốc ngón giữa tay 1
                const hand2 = results.multiHandLandmarks[1][9]; // Gốc ngón giữa tay 2
                
                const dist = Math.sqrt(
                    Math.pow(hand1.x - hand2.x, 2) + 
                    Math.pow(hand1.y - hand2.y, 2)
                );

                // Map khoảng cách từ camera (0.2 -> 0.7) sang độ mở rộng (1.0 -> 5.0)
                expansionFactor = THREE.MathUtils.lerp(expansionFactor, dist * 8, 0.1);
            } else {
                statusDisplay.innerText = "Hãy đưa 2 tay vào camera";
                expansionFactor = THREE.MathUtils.lerp(expansionFactor, 1, 0.05); // Tự thu gọn
            }
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });
        cameraUtils.start();

        // --- CẬP NHẬT MÀU SẮC & GIAO DIỆN ---
        document.getElementById('colorPicker').addEventListener('input', (e) => {
            material.color.set(e.target.value);
        });

        // --- VÒNG LẶP RENDER ---
        function animate() {
            requestAnimationFrame(animate);

            const positionsArr = geometry.attributes.position.array;
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                // Cập nhật vị trí dựa trên expansionFactor
                positionsArr[i3] = originalPositions[i3] * expansionFactor;
                positionsArr[i3+1] = originalPositions[i3+1] * expansionFactor;
                positionsArr[i3+2] = originalPositions[i3+2] * expansionFactor;
            }
            geometry.attributes.position.needsUpdate = true;

            particles.rotation.y += 0.002;
            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>
</html>